% inputs: #block_name = [Gain(dB) NF(dB) IIP3(dBm)] 
clear all;
Switch_1 = [-1.5 1.5 41.5];
Balun_1 = [-1.5 1.5 1000];
LNA = [20 2 -5]; 
Attenuator_1 = [-4 4 24];
Amplifier = [22.5 4 -3.5];
Switch_2 = [-1.5 1.5 41.5];
Attenuator_2 = [-4 4 24];
Phase_Shifter =[-5.5 5.5 25.5];
Wilkenson = [-2 2 1000];
Balun_2 = [-1.5 1.5 1000];


N =10;

att1_gains = [Attenuator_1(1)*ones(46,1); (linspace(Attenuator_1(1)-1,Attenuator_1(1)-15,15))' ;(Attenuator_1(1)-15)*ones(39,1)];
att2_gains = [Attenuator_2(1)*ones(61,1); (linspace(Attenuator_2(1)-1,Attenuator_2(1)-15,15))' ;(Attenuator_2(1)-15)*ones(24,1)];
att1_NFs = [Attenuator_1(2)*ones(46,1); (linspace(Attenuator_1(2)+1,Attenuator_1(2)+15,15))' ;(Attenuator_1(2)+15)*ones(39,1)];
att2_NFs = [Attenuator_2(2)*ones(61,1); (linspace(Attenuator_2(2)+1,Attenuator_2(2)+15,15))' ;(Attenuator_2(2)+15)*ones(24,1)];
%att1_IIP3s = [Attenuator_1(1)*ones(45,1); (linspace(Attenuator_1(1)+3,Attenuator_1(1)+45,15))' ;(Attenuator_1(1)+45)*ones(40,1)];
%att2_IIP3s = [Attenuator_2(1)*ones(60,1); (linspace(Attenuator_2(1)+3,Attenuator_2(1)+45,15))' ;(Attenuator_2(1)+45)*ones(25,1)];


% using friis equation to calcuate chain OIP3 and total NF:
Gains_dB = [
    Switch_1(1)*ones(100,1)...
    LNA(1)*ones(100,1)...
    Balun_1(1)*ones(100,1)...
    att1_gains ...
    Amplifier(1)*ones(100,1) ...
    Switch_2(1)*ones(100,1) ...
    att2_gains ...
    Phase_Shifter(1)*ones(100,1)...
    Wilkenson(1)*ones(100,1)...
    Balun_2(1)*ones(100,1)...
    ];
NFs_dB = [
    Switch_1(2)*ones(100,1)...
    LNA(2)*ones(100,1)...
    Balun_1(2)*ones(100,1)...
    att1_NFs ...
    Amplifier(2)*ones(100,1) ...
    Switch_2(2)*ones(100,1) ...
    att2_NFs ...
    Phase_Shifter(2)*ones(100,1)...
    Wilkenson(2)*ones(100,1)...
    Balun_2(2)*ones(100,1)...
    ];
IIP3s_dBm = [
    Switch_1(3)*ones(100,1)...
    LNA(3)*ones(100,1)...
    Balun_1(3)*ones(100,1)...
    Attenuator_1(3)*ones(100,1) ...
    Amplifier(3)*ones(100,1) ...
    Switch_2(3)*ones(100,1) ...
    Attenuator_2(3)*ones(100,1)...
    Phase_Shifter(3)*ones(100,1)...
    Wilkenson(3)*ones(100,1)...
    Balun_2(3)*ones(100,1)...
    ];

Gains = 10.^(Gains_dB/10);
NFs = 10.^(NFs_dB/10);
IIP3s = 10.^(IIP3s_dBm/10);

Cumlative_Gains = [ones(100,1) cumprod(Gains(:,1:N-1), 2)]; %[g1 g1g2 g1g2g3 ...]
NF_contributions = (NFs - [zeros(100,1) ones(100,N-1)])./Cumlative_Gains;

IIP3_contributions = Cumlative_Gains./(IIP3s);
total_IIP3_dB = 10*log10(1./sum(IIP3_contributions,2));

total_NF_dB = 10*log10(sum(NF_contributions,2));

% calculating SNR, SDR, and SNDR for a given channel BW:

BW = 200e6;
Pin = -100:1:-1; % in dBm

SNR_o_dB = Pin-total_NF_dB'+174-10*log10(BW)+[6; 9; 12];
SDR_dB = 2*(total_IIP3_dB'-Pin)+ [0; 0; 0];
SNR_o = 10.^(SNR_o_dB/10);
SDR = 10.^(SDR_dB/10);

SNDR = (SNR_o.*SDR)./(SNR_o+SDR);
SNDR_dB = 10*log10(SNDR);

figure();
plot(Pin, SNR_o_dB);
hold on;
plot(Pin,SDR_dB);
plot(Pin, SNDR_dB);
title('SNR, SDR, SNDR of RX @Pout=-27 200MHz');
xlabel('Pin(dBm)');
hold off;